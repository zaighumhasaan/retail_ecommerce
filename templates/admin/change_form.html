{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">{{ title }}</h1>
        <p class="text-muted mb-0">
            {% if is_popup %}
                Add {{ opts.verbose_name }}
            {% else %}
                {% if change %}
                    Edit {{ original|truncatechars:50 }}
                {% else %}
                    Add {{ opts.verbose_name }}
                {% endif %}
            {% endif %}
        </p>
    </div>
    <div class="d-flex gap-2">
        {% if change and has_delete_permission %}
        <a href="{% url 'admin:'|add:opts.app_label|add:'_'|add:opts.model_name|add:'_delete' original.pk %}" 
           class="btn btn-outline-danger" 
           onclick="return confirm('Are you sure you want to delete this {{ opts.verbose_name }}?')">
            <i class="bi bi-trash me-2"></i>Delete
        </a>
        {% endif %}
        <a href="{% url 'admin:'|add:opts.app_label|add:'_'|add:opts.model_name|add:'_changelist' %}" 
           class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to List
        </a>
        <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">
            <i class="bi bi-arrow-left me-2"></i>Take Me Back
        </button>
    </div>
</div>

{% if form.errors %}
    <div class="alert alert-danger">
        <h5><i class="bi bi-exclamation-triangle me-2"></i>Please correct the errors below</h5>
        {{ form.non_field_errors }}
    </div>
{% endif %}

<form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    
    {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {{ form.non_field_errors }}
        </div>
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        {% if change %}Edit{% else %}Add{% endif %} {{ opts.verbose_name }}
                    </h5>
                </div>
                <div class="card-body">
                    {% for fieldset in adminform %}
                        {% include "admin/includes/fieldset.html" %}
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-gear me-2"></i>Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" name="_save">
                            <i class="bi bi-check-circle me-2"></i>Save
                        </button>
                        <button type="submit" class="btn btn-outline-primary" name="_addanother">
                            <i class="bi bi-plus-circle me-2"></i>Save and add another
                        </button>
                        <button type="submit" class="btn btn-outline-primary" name="_continue">
                            <i class="bi bi-pencil me-2"></i>Save and continue editing
                        </button>
                    </div>
                </div>
            </div>

            {% if change and has_view_permission %}
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-clock me-2"></i>History
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-2">Created: {{ original.created_at|date:"M d, Y H:i" }}</p>
                    <p class="text-muted small mb-0">Last updated: {{ original.updated_at|date:"M d, Y H:i" }}</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</form>

<style>
.field-group {
    margin-bottom: 1.5rem;
}

.field-group label {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
    display: block;
}

.field-group .form-control,
.field-group .form-select {
    border-radius: 0.5rem;
    border: 1px solid #d1d5db;
    padding: 0.75rem;
}

.field-group .form-control:focus,
.field-group .form-select:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
}

.field-group .form-text {
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

.field-group .errorlist {
    list-style: none;
    padding: 0;
    margin: 0.25rem 0 0 0;
}

.field-group .errorlist li {
    color: #dc2626;
    font-size: 0.875rem;
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 0.375rem;
    padding: 0.5rem;
    margin-bottom: 0.25rem;
}

.help_text {
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

.required {
    color: #dc2626;
}

.inline-group {
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
}

.inline-group .inline-related {
    border-bottom: 1px solid #e5e7eb;
    padding: 1rem;
}

.inline-group .inline-related:last-child {
    border-bottom: none;
}

.inline-group h3 {
    background: #f9fafb;
    margin: 0;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
}

.inline-group .form-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.inline-group .form-row .form-group {
    flex: 1;
    margin-bottom: 0;
}

.inline-group .delete {
    color: #dc2626;
    text-decoration: none;
    font-size: 0.875rem;
}

.inline-group .delete:hover {
    color: #b91c1c;
    text-decoration: underline;
}
</style>

<script>
// Enhanced back navigation
document.addEventListener('DOMContentLoaded', function() {
    // Add click handler for "Take Me Back" button
    const takeMeBackBtn = document.querySelector('button[onclick="window.history.back()"]');
    if (takeMeBackBtn) {
        takeMeBackBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (window.history.length > 1) {
                window.history.back();
            } else {
                // Fallback to changelist if no history
                window.location.href = "{% url 'admin:'|add:opts.app_label|add:'_'|add:opts.model_name|add:'_changelist' %}";
            }
        });
    }
});

// Add visual feedback for form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    if (form) {
        // Add visual feedback for required fields
        const requiredFields = form.querySelectorAll('input[required], select[required], textarea[required]');
        requiredFields.forEach(field => {
            field.addEventListener('blur', function() {
                if (!this.value.trim()) {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            });
        });
    }
});

// Add file upload preview
document.querySelectorAll('input[type="file"]').forEach(input => {
    input.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.createElement('img');
                preview.src = e.target.result;
                preview.style.maxWidth = '200px';
                preview.style.maxHeight = '200px';
                preview.style.marginTop = '10px';
                preview.style.borderRadius = '0.5rem';
                
                const existingPreview = input.parentNode.querySelector('img');
                if (existingPreview) {
                    existingPreview.remove();
                }
                
                input.parentNode.appendChild(preview);
            };
            reader.readAsDataURL(file);
        }
    });
});
</script>
{% endblock %}
